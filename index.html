<!DOCTYPE html>
<html>
  <head>
    <title>Searchkick - Search Made Easy</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0-rc1/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="github.css">
    <style>
      body {
        padding-bottom: 20px;
      }

      .container {
        max-width: 800px;
      }

      h2, h3 {
        margin-top: 1em;
      }

      p {
        margin-top: 1.5em;
        margin-bottom: 1.5em;
      }

      p.lead {
        margin-top: 0;
      }
    </style>

    <meta property="og:title" content="Searchkick"/>
    <meta property="og:url" content="http://ankane.github.io/searchkick/"/>
    <meta property="og:image" content="https://github.global.ssl.fastly.net/images/gravatars/gravatar-user-420.png"/>
    <meta property="og:description" content="Search made easy"/>

  </head>
  <body>
    <a href="https://github.com/ankane/searchkick" style="position: fixed; top: 15px; right: 15px; border: 0; z-index: 1000;" class="btn btn-info">Github</a>

    <div class="container">
      <div class="row">
        <div class="col-12">
          <h1 style="margin-bottom: 0.5em; margin-top: 15px;">Searchkick</h1>
        </div>
      </div>
      <div class="row">
        <div class="col-sm-6">
          <p class="lead"><img class="emoji" title=":rocket:" alt=":rocket:" src="https://github.global.ssl.fastly.net/images/icons/emoji/rocket.png" height="20" width="20" align="absmiddle"> Intelligent search made easy</p>
        </div>
        <div class="col-sm-6">
          <p class="lead">
          <img class="emoji" title=":tangerine:" alt=":tangerine:" src="https://github.global.ssl.fastly.net/images/icons/emoji/tangerine.png" height="20" width="20" align="absmiddle"> Battle-tested at <a href="https://www.instacart.com">Instacart</a></p>
        </div>
      </div>
      <div class="row">
        <div class="col-12">
          <hr style="margin-top: 0;" />

<!-- begin readme -->

<p>Searchkick learns what <strong>your users</strong> are looking for.  As more people search, it gets smarter and the results get better.  It’s friendly for developers - and magical for your users.</p>

<p>Searchkick handles:</p>

<ul>
<li>stemming - <code>tomatoes</code> matches <code>tomato</code>
</li>
<li>special characters - <code>jalapeno</code> matches <code>jalapeño</code>
</li>
<li>extra whitespace - <code>dishwasher</code> matches <code>dish washer</code>
</li>
<li>misspellings - <code>zuchini</code> matches <code>zucchini</code>
</li>
<li>custom synonyms - <code>qtip</code> matches <code>cotton swab</code>
</li>
</ul><p>Plus:</p>

<ul>
<li>query like SQL - no need to learn a new query language</li>
<li>reindex without downtime</li>
</ul>

<h2>
<a name="get-started" class="anchor" href="#get-started"><span class="octicon octicon-link"></span></a>Get Started</h2>

<p><a href="http://www.elasticsearch.org/guide/reference/setup/installation/">Install Elasticsearch</a>. For Homebrew, use:</p>

<div class="highlight"><pre>brew install elasticsearch
</pre></div>

<p>Add this line to your application’s Gemfile:</p>

<div class="highlight"><pre><span class="n">gem</span> <span class="s2">"searchkick"</span>
</pre></div>

<p>Add searchkick to models you want to search.</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="n">searchkick</span>
<span class="k">end</span>
</pre></div>

<p>Add data to the search index.</p>

<div class="highlight"><pre><span class="no">Product</span><span class="o">.</span><span class="n">reindex</span>
</pre></div>

<p>And to query, use:</p>

<div class="highlight"><pre><span class="n">products</span> <span class="o">=</span> <span class="no">Product</span><span class="o">.</span><span class="n">search</span> <span class="s2">"2% Milk"</span>
<span class="n">products</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="n">product</span><span class="o">.</span><span class="n">name</span>
<span class="k">end</span>
</pre></div>

<h3>
<a name="queries" class="anchor" href="#queries"><span class="octicon octicon-link"></span></a>Queries</h3>

<p>Query like SQL</p>

<div class="highlight"><pre><span class="no">Product</span><span class="o">.</span><span class="n">search</span> <span class="s2">"2% Milk"</span><span class="p">,</span> <span class="ss">where</span><span class="p">:</span> <span class="p">{</span><span class="n">in_stock</span><span class="p">:</span> <span class="kp">true</span><span class="p">},</span> <span class="ss">limit</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="ss">offset</span><span class="p">:</span> <span class="mi">50</span>
</pre></div>

<p>Search specific fields</p>

<div class="highlight"><pre><span class="ss">fields</span><span class="p">:</span> <span class="o">[</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:brand</span><span class="o">]</span>
</pre></div>

<p>Where</p>

<div class="highlight"><pre><span class="ss">where</span><span class="p">:</span> <span class="p">{</span>
  <span class="n">expires_at</span><span class="p">:</span> <span class="p">{</span><span class="ss">gt</span><span class="p">:</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="p">},</span> <span class="c1"># lt, gte, lte also available</span>
  <span class="n">orders_count</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">10</span><span class="p">,</span>        <span class="c1"># equivalent to {gte: 1, lte: 10}</span>
  <span class="n">aisle_id</span><span class="p">:</span> <span class="o">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">30</span><span class="o">]</span><span class="p">,</span>         <span class="c1"># in</span>
  <span class="n">store_id</span><span class="p">:</span> <span class="p">{</span><span class="ow">not</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>         <span class="c1"># not</span>
  <span class="n">aisle_id</span><span class="p">:</span> <span class="p">{</span><span class="ow">not</span><span class="p">:</span> <span class="o">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">30</span><span class="o">]</span><span class="p">},</span>  <span class="c1"># not in</span>
  <span class="ow">or</span><span class="p">:</span> <span class="o">[</span>
    <span class="o">[</span><span class="p">{</span><span class="n">in_stock</span><span class="p">:</span> <span class="kp">true</span><span class="p">},</span> <span class="p">{</span><span class="ss">backordered</span><span class="p">:</span> <span class="kp">true</span><span class="p">}</span><span class="o">]</span>
  <span class="o">]</span>
<span class="p">}</span>
</pre></div>

<p>Order</p>

<div class="highlight"><pre><span class="ss">order</span><span class="p">:</span> <span class="p">{</span><span class="ss">_score</span><span class="p">:</span> <span class="ss">:desc</span><span class="p">}</span> <span class="c1"># most relevant first - default</span>
</pre></div>

<p>Limit / offset</p>

<div class="highlight"><pre><span class="ss">limit</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="ss">offset</span><span class="p">:</span> <span class="mi">40</span>
</pre></div>

<p>Boost by a field</p>

<div class="highlight"><pre><span class="ss">boost</span><span class="p">:</span> <span class="s2">"orders_count"</span> <span class="c1"># give popular documents a little boost</span>
</pre></div>

<h3>
<a name="pagination" class="anchor" href="#pagination"><span class="octicon octicon-link"></span></a>Pagination</h3>

<p>Plays nicely with kaminari and will_paginate.</p>

<div class="highlight"><pre><span class="c1"># controller</span>
<span class="vi">@products</span> <span class="o">=</span> <span class="no">Product</span><span class="o">.</span><span class="n">search</span> <span class="s2">"milk"</span><span class="p">,</span> <span class="ss">page</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">,</span> <span class="n">per_page</span><span class="p">:</span> <span class="mi">20</span>

<span class="c1"># view</span>
<span class="o">&lt;%=</span> <span class="n">paginate</span> <span class="vi">@products</span> <span class="o">%&gt;</span>
</pre></div>

<h3>
<a name="partial-matches" class="anchor" href="#partial-matches"><span class="octicon octicon-link"></span></a>Partial Matches</h3>

<p>By default, results must match all words in the query.</p>

<div class="highlight"><pre><span class="no">Product</span><span class="o">.</span><span class="n">search</span> <span class="s2">"fresh honey"</span> <span class="c1"># fresh AND honey</span>
</pre></div>

<p>To change this, use:</p>

<div class="highlight"><pre><span class="no">Product</span><span class="o">.</span><span class="n">search</span> <span class="s2">"fresh honey"</span><span class="p">,</span> <span class="ss">partial</span><span class="p">:</span> <span class="kp">true</span> <span class="c1"># fresh OR honey</span>
</pre></div>

<h3>
<a name="synonyms" class="anchor" href="#synonyms"><span class="octicon octicon-link"></span></a>Synonyms</h3>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="n">searchkick</span> <span class="ss">synonyms</span><span class="p">:</span> <span class="o">[[</span><span class="s2">"scallion"</span><span class="p">,</span> <span class="s2">"green onion"</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="s2">"qtip"</span><span class="p">,</span> <span class="s2">"cotton swab"</span><span class="o">]]</span>
<span class="k">end</span>
</pre></div>

<p>You must call <code>Product.reindex</code> after changing synonyms.</p>

<h3>
<a name="indexing" class="anchor" href="#indexing"><span class="octicon octicon-link"></span></a>Indexing</h3>

<p>Control what data is indexed with the <code>search_data</code> method.</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="k">def</span> <span class="nf">search_data</span>
    <span class="n">as_json</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:active</span><span class="o">]</span><span class="p">,</span> <span class="kp">include</span><span class="p">:</span> <span class="p">{</span><span class="ss">brand</span><span class="p">:</span> <span class="p">{</span><span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:city</span><span class="o">]</span><span class="p">}}</span>
    <span class="c1"># or equivalently</span>
    <span class="p">{</span>
      <span class="nb">name</span><span class="p">:</span> <span class="nb">name</span><span class="p">,</span>
      <span class="ss">active</span><span class="p">:</span> <span class="n">active</span><span class="p">,</span>
      <span class="ss">brand</span><span class="p">:</span> <span class="p">{</span>
        <span class="ss">city</span><span class="p">:</span> <span class="n">brand</span><span class="o">.</span><span class="n">city</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>Searchkick uses <code>find_in_batches</code> to import documents.  To eager load associations, use the <code>search_import</code> scope.</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="n">scope</span> <span class="ss">:search_import</span><span class="p">,</span> <span class="n">includes</span><span class="p">(</span><span class="ss">:searches</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>

<h3>
<a name="keep-getting-better" class="anchor" href="#keep-getting-better"><span class="octicon octicon-link"></span></a>Keep Getting Better</h3>

<p>Searchkick uses conversion data to learn what users are looking for.  If a user searches for “ice cream” and adds Ben &amp; Jerry’s Chunky Monkey to the cart (our conversion metric at Instacart), that item gets a little more weight for similar searches.</p>

<p>The first step is to define your conversion metric and start tracking conversions.  The database works well for low volume, but feel free to use Redis or another datastore.</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Search</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="n">belongs_to</span> <span class="ss">:product</span>
  <span class="c1"># fields: id, query, searched_at, converted_at, product_id</span>
<span class="k">end</span>
</pre></div>

<p>Add conversions to the index.</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="n">has_many</span> <span class="ss">:searches</span>

  <span class="k">def</span> <span class="nf">search_data</span>
    <span class="p">{</span>
      <span class="nb">name</span><span class="p">:</span> <span class="nb">name</span><span class="p">,</span>
      <span class="ss">conversions</span><span class="p">:</span> <span class="n">searches</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">"query"</span><span class="p">)</span><span class="o">.</span><span class="n">count</span>
    <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>Reindex and set up a cron job to add new conversions daily.</p>

<div class="highlight"><pre><span class="n">rake</span> <span class="ss">searchkick</span><span class="p">:</span><span class="n">reindex</span> <span class="no">CLASS</span><span class="o">=</span><span class="no">Product</span>
</pre></div>

<h3>
<a name="facets" class="anchor" href="#facets"><span class="octicon octicon-link"></span></a>Facets</h3>

<div class="highlight"><pre><span class="n">search</span> <span class="o">=</span> <span class="no">Product</span><span class="o">.</span><span class="n">search</span> <span class="s2">"2% Milk"</span><span class="p">,</span> <span class="ss">facets</span><span class="p">:</span> <span class="o">[</span><span class="ss">:store_id</span><span class="p">,</span> <span class="ss">:aisle_id</span><span class="o">]</span>
<span class="nb">p</span> <span class="n">search</span><span class="o">.</span><span class="n">facets</span>
</pre></div>

<p>Advanced</p>

<div class="highlight"><pre><span class="no">Product</span><span class="o">.</span><span class="n">search</span> <span class="s2">"2% Milk"</span><span class="p">,</span> <span class="ss">facets</span><span class="p">:</span> <span class="p">{</span><span class="n">store_id</span><span class="p">:</span> <span class="p">{</span><span class="ss">where</span><span class="p">:</span> <span class="p">{</span><span class="n">in_stock</span><span class="p">:</span> <span class="kp">true</span><span class="p">}}}</span>
</pre></div>

<h2>
<a name="deployment" class="anchor" href="#deployment"><span class="octicon octicon-link"></span></a>Deployment</h2>

<h3>
<a name="heroku" class="anchor" href="#heroku"><span class="octicon octicon-link"></span></a>Heroku</h3>

<p>Choose an add-on: <a href="https://addons.heroku.com/searchbox">SearchBox</a>, <a href="https://addons.heroku.com/bonsai">Bonsai</a>, or <a href="https://addons.heroku.com/foundelasticsearch">Found</a>.</p>

<div class="highlight"><pre><span class="c"># SearchBox</span>
heroku addons:add searchbox:starter

<span class="c"># Bonsai</span>
heroku addons:add bonsai

<span class="c"># Found</span>
heroku addons:add foundelasticsearch
</pre></div>

<p>And create an initializer <code>config/initializers/elasticsearch.rb</code> with:</p>

<div class="highlight"><pre><span class="c1"># SearchBox</span>
<span class="no">ENV</span><span class="o">[</span><span class="s2">"ELASTICSEARCH_URL"</span><span class="o">]</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">"SEARCHBOX_URL"</span><span class="o">]</span>

<span class="c1"># Bonsai</span>
<span class="no">ENV</span><span class="o">[</span><span class="s2">"ELASTICSEARCH_URL"</span><span class="o">]</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">"BONSAI_URL"</span><span class="o">]</span>

<span class="c1"># Found</span>
<span class="no">ENV</span><span class="o">[</span><span class="s2">"ELASTICSEARCH_URL"</span><span class="o">]</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">"FOUNDELASTICSEARCH_URL"</span><span class="o">]</span>
</pre></div>

<p>Then deploy and reindex:</p>

<div class="highlight"><pre>heroku run rake searchkick:reindex <span class="nv">CLASS</span><span class="o">=</span>Product
</pre></div>

<h2>
<a name="reference" class="anchor" href="#reference"><span class="octicon octicon-link"></span></a>Reference</h2>

<p>Reindex one record</p>

<div class="highlight"><pre><span class="n">product</span> <span class="o">=</span> <span class="no">Product</span><span class="o">.</span><span class="n">find</span> <span class="mi">10</span>
<span class="n">product</span><span class="o">.</span><span class="n">reindex</span>
</pre></div>

<p>Use a different index name</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="n">searchkick</span> <span class="n">index_name</span><span class="p">:</span> <span class="s2">"products_v2"</span>
<span class="k">end</span>
</pre></div>

<p>Eagar load associations</p>

<div class="highlight"><pre><span class="no">Product</span><span class="o">.</span><span class="n">search</span> <span class="s2">"milk"</span><span class="p">,</span> <span class="kp">include</span><span class="p">:</span> <span class="o">[</span><span class="ss">:brand</span><span class="p">,</span> <span class="ss">:stores</span><span class="o">]</span>
</pre></div>

<p>Do not load models</p>

<div class="highlight"><pre><span class="no">Product</span><span class="o">.</span><span class="n">search</span> <span class="s2">"milk"</span><span class="p">,</span> <span class="nb">load</span><span class="p">:</span> <span class="kp">false</span>
</pre></div>

<h2>
<a name="migrating-from-tire" class="anchor" href="#migrating-from-tire"><span class="octicon octicon-link"></span></a>Migrating from Tire</h2>

<ol>
<li>
<p>Change <code>search</code> methods to <code>tire.search</code> and add index name in existing search calls</p>

<div class="highlight"><pre><span class="no">Product</span><span class="o">.</span><span class="n">search</span> <span class="s2">"fruit"</span>
</pre></div>

<p>should be replaced with</p>

<div class="highlight"><pre><span class="no">Product</span><span class="o">.</span><span class="n">tire</span><span class="o">.</span><span class="n">search</span> <span class="s2">"fruit"</span><span class="p">,</span> <span class="ss">index</span><span class="p">:</span> <span class="s2">"products"</span>
</pre></div>
</li>
<li>
<p>Replace tire mapping w/ searchkick method</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
<span class="n">searchkick</span>
<span class="k">end</span>
</pre></div>
</li>
<li>
<p>Deploy and reindex</p>

<div class="highlight"><pre><span class="n">rake</span> <span class="ss">searchkick</span><span class="p">:</span><span class="n">reindex</span> <span class="no">CLASS</span><span class="o">=</span><span class="no">Product</span> <span class="c1"># or Product.reindex in the console</span>
</pre></div>
</li>
<li><p>Once it finishes, replace search calls w/ searchkick calls</p></li>
</ol><h2>
<a name="elasticsearch-gotchas" class="anchor" href="#elasticsearch-gotchas"><span class="octicon octicon-link"></span></a>Elasticsearch Gotchas</h2>

<h3>
<a name="inconsistent-scores" class="anchor" href="#inconsistent-scores"><span class="octicon octicon-link"></span></a>Inconsistent Scores</h3>

<p>Due to the distributed nature of Elasticsearch, you can get incorrect results when the number of documents in the index is low.  You can <a href="http://www.elasticsearch.org/blog/understanding-query-then-fetch-vs-dfs-query-then-fetch/">read more about it here</a>.  To fix this, do:</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="n">searchkick</span> <span class="ss">settings</span><span class="p">:</span> <span class="p">{</span><span class="n">number_of_shards</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<span class="k">end</span>
</pre></div>

<h2>
<a name="thanks" class="anchor" href="#thanks"><span class="octicon octicon-link"></span></a>Thanks</h2>

<p>Thanks to Karel Minarik for <a href="https://github.com/karmi/tire">Tire</a> and Jaroslav Kalistsuk for <a href="https://gist.github.com/jarosan/3124884">zero downtime reindexing</a>.</p>

<h2>
<a name="todo" class="anchor" href="#todo"><span class="octicon octicon-link"></span></a>TODO</h2>

<ul>
<li>Make Searchkick work with any language</li>
<li>Built-in synonyms from WordNet</li>
</ul><h2>
<a name="contributing" class="anchor" href="#contributing"><span class="octicon octicon-link"></span></a>Contributing</h2>

<ol>
<li>Fork it</li>
<li>Create your feature branch (<code>git checkout -b my-new-feature</code>)</li>
<li>Commit your changes (<code>git commit -am 'Add some feature'</code>)</li>
<li>Push to the branch (<code>git push origin my-new-feature</code>)</li>
<li>Create new Pull Request</li>
</ol>

<!-- end readme -->

        </div>
      </div>
    </div>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-39027070-6', 'github.io');
      ga('send', 'pageview');
    </script>

  </body>
</html>
