<!DOCTYPE html>
<html>
  <head>
    <title>Searchkick - Search Made Easy</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0-rc1/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="github.css">
    <style>
      body {
        padding-bottom: 20px;
      }

      .container {
        max-width: 800px;
      }

      h2, h3, h4 {
        margin-top: 1em;
      }

      p {
        margin-top: 1.5em;
        margin-bottom: 1.5em;
      }

      p.lead {
        margin-top: 0;
      }
    </style>

    <meta property="og:title" content="Searchkick"/>
    <meta property="og:url" content="http://ankane.github.io/searchkick/"/>
    <meta property="og:image" content="https://github.global.ssl.fastly.net/images/gravatars/gravatar-user-420.png"/>
    <meta property="og:description" content="Search made easy"/>

  </head>
  <body>
    <a href="https://github.com/ankane/searchkick" style="position: fixed; top: 15px; right: 15px; border: 0; z-index: 1000;" class="btn btn-info">Github</a>

    <div class="container">
      <div class="row">
        <div class="col-12">
          <h1 style="margin-bottom: 0.5em; margin-top: 15px;">Searchkick</h1>
        </div>
      </div>
      <div class="row">
        <div class="col-sm-6">
          <p class="lead"><img class="emoji" title=":rocket:" alt=":rocket:" src="https://github.global.ssl.fastly.net/images/icons/emoji/rocket.png" height="20" width="20" align="absmiddle"> Intelligent search made easy</p>
        </div>
        <div class="col-sm-6">
          <p class="lead">
          <img class="emoji" title=":tangerine:" alt=":tangerine:" src="https://github.global.ssl.fastly.net/images/icons/emoji/tangerine.png" height="20" width="20" align="absmiddle"> Battle-tested at <a href="https://www.instacart.com">Instacart</a></p>
        </div>
      </div>
      <div class="row">
        <div class="col-12">
          <hr style="margin-top: 0;" />

<!-- begin readme -->

<p>Searchkick learns what <strong>your users</strong> are looking for.  As more people search, it gets smarter and the results get better.  It’s friendly for developers - and magical for your users.</p>

<p>Searchkick handles:</p>

<ul>
<li>stemming - <code>tomatoes</code> matches <code>tomato</code>
</li>
<li>special characters - <code>jalapeno</code> matches <code>jalapeño</code>
</li>
<li>extra whitespace - <code>dishwasher</code> matches <code>dish washer</code>
</li>
<li>misspellings - <code>zuchini</code> matches <code>zucchini</code>
</li>
<li>custom synonyms - <code>qtip</code> matches <code>cotton swab</code>
</li>
</ul><p>Plus:</p>

<ul>
<li>query like SQL - no need to learn a new query language</li>
<li>reindex without downtime</li>
<li>easily personalize results for each user</li>
<li>autocomplete</li>
<li>“Did you mean” suggestions</li>
<li>works with ActiveRecord and Mongoid</li>
</ul>

<h2>
<a name="get-started" class="anchor" href="#get-started"><span class="octicon octicon-link"></span></a>Get Started</h2>

<p><a href="http://www.elasticsearch.org/guide/reference/setup/installation/">Install Elasticsearch</a>. For Homebrew, use:</p>

<div class="highlight"><pre>brew install elasticsearch
</pre></div>

<p>Add this line to your application’s Gemfile:</p>

<div class="highlight"><pre><span class="n">gem</span> <span class="s2">"searchkick"</span>
</pre></div>

<p>Add searchkick to models you want to search.</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="n">searchkick</span>
<span class="k">end</span>
</pre></div>

<p>Add data to the search index.</p>

<div class="highlight"><pre><span class="no">Product</span><span class="o">.</span><span class="n">reindex</span>
</pre></div>

<p>And to query, use:</p>

<div class="highlight"><pre><span class="n">products</span> <span class="o">=</span> <span class="no">Product</span><span class="o">.</span><span class="n">search</span> <span class="s2">"2% Milk"</span>
<span class="n">products</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="n">product</span><span class="o">.</span><span class="n">name</span>
<span class="k">end</span>
</pre></div>

<h3>
<a name="queries" class="anchor" href="#queries"><span class="octicon octicon-link"></span></a>Queries</h3>

<p>Query like SQL</p>

<div class="highlight"><pre><span class="no">Product</span><span class="o">.</span><span class="n">search</span> <span class="s2">"2% Milk"</span><span class="p">,</span> <span class="ss">where</span><span class="p">:</span> <span class="p">{</span><span class="n">in_stock</span><span class="p">:</span> <span class="kp">true</span><span class="p">},</span> <span class="ss">limit</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="ss">offset</span><span class="p">:</span> <span class="mi">50</span>
</pre></div>

<p>Search specific fields</p>

<div class="highlight"><pre><span class="ss">fields</span><span class="p">:</span> <span class="o">[</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:brand</span><span class="o">]</span>
</pre></div>

<p>Where</p>

<div class="highlight"><pre><span class="ss">where</span><span class="p">:</span> <span class="p">{</span>
  <span class="n">expires_at</span><span class="p">:</span> <span class="p">{</span><span class="ss">gt</span><span class="p">:</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="p">},</span> <span class="c1"># lt, gte, lte also available</span>
  <span class="n">orders_count</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">10</span><span class="p">,</span>        <span class="c1"># equivalent to {gte: 1, lte: 10}</span>
  <span class="n">aisle_id</span><span class="p">:</span> <span class="o">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">30</span><span class="o">]</span><span class="p">,</span>         <span class="c1"># in</span>
  <span class="n">store_id</span><span class="p">:</span> <span class="p">{</span><span class="ow">not</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>         <span class="c1"># not</span>
  <span class="n">aisle_id</span><span class="p">:</span> <span class="p">{</span><span class="ow">not</span><span class="p">:</span> <span class="o">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">30</span><span class="o">]</span><span class="p">},</span>  <span class="c1"># not in</span>
  <span class="ow">or</span><span class="p">:</span> <span class="o">[</span>
    <span class="o">[</span><span class="p">{</span><span class="n">in_stock</span><span class="p">:</span> <span class="kp">true</span><span class="p">},</span> <span class="p">{</span><span class="ss">backordered</span><span class="p">:</span> <span class="kp">true</span><span class="p">}</span><span class="o">]</span>
  <span class="o">]</span>
<span class="p">}</span>
</pre></div>

<p>Order</p>

<div class="highlight"><pre><span class="ss">order</span><span class="p">:</span> <span class="p">{</span><span class="ss">_score</span><span class="p">:</span> <span class="ss">:desc</span><span class="p">}</span> <span class="c1"># most relevant first - default</span>
</pre></div>

<p>Limit / offset</p>

<div class="highlight"><pre><span class="ss">limit</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="ss">offset</span><span class="p">:</span> <span class="mi">40</span>
</pre></div>

<p>Boost by a field</p>

<div class="highlight"><pre><span class="ss">boost</span><span class="p">:</span> <span class="s2">"orders_count"</span> <span class="c1"># give popular documents a little boost</span>
</pre></div>

<h3>
<a name="pagination" class="anchor" href="#pagination"><span class="octicon octicon-link"></span></a>Pagination</h3>

<p>Plays nicely with kaminari and will_paginate.</p>

<div class="highlight"><pre><span class="c1"># controller</span>
<span class="vi">@products</span> <span class="o">=</span> <span class="no">Product</span><span class="o">.</span><span class="n">search</span> <span class="s2">"milk"</span><span class="p">,</span> <span class="ss">page</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">,</span> <span class="n">per_page</span><span class="p">:</span> <span class="mi">20</span>

<span class="c1"># view</span>
<span class="o">&lt;%=</span> <span class="n">paginate</span> <span class="vi">@products</span> <span class="o">%&gt;</span>
</pre></div>

<h3>
<a name="partial-matches" class="anchor" href="#partial-matches"><span class="octicon octicon-link"></span></a>Partial Matches</h3>

<p>By default, results must match all words in the query.</p>

<div class="highlight"><pre><span class="no">Product</span><span class="o">.</span><span class="n">search</span> <span class="s2">"fresh honey"</span> <span class="c1"># fresh AND honey</span>
</pre></div>

<p>To change this, use:</p>

<div class="highlight"><pre><span class="no">Product</span><span class="o">.</span><span class="n">search</span> <span class="s2">"fresh honey"</span><span class="p">,</span> <span class="ss">partial</span><span class="p">:</span> <span class="kp">true</span> <span class="c1"># fresh OR honey</span>
</pre></div>

<h3>
<a name="synonyms" class="anchor" href="#synonyms"><span class="octicon octicon-link"></span></a>Synonyms</h3>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="n">searchkick</span> <span class="ss">synonyms</span><span class="p">:</span> <span class="o">[[</span><span class="s2">"scallion"</span><span class="p">,</span> <span class="s2">"green onion"</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="s2">"qtip"</span><span class="p">,</span> <span class="s2">"cotton swab"</span><span class="o">]]</span>
<span class="k">end</span>
</pre></div>

<p>Call <code>Product.reindex</code> after changing synonyms.</p>

<h3>
<a name="indexing" class="anchor" href="#indexing"><span class="octicon octicon-link"></span></a>Indexing</h3>

<p>Control what data is indexed with the <code>search_data</code> method. Call <code>Product.reindex</code> after changing this method.</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="k">def</span> <span class="nf">search_data</span>
    <span class="n">as_json</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:active</span><span class="o">]</span>
    <span class="c1"># or equivalently</span>
    <span class="p">{</span>
      <span class="nb">name</span><span class="p">:</span> <span class="nb">name</span><span class="p">,</span>
      <span class="ss">active</span><span class="p">:</span> <span class="n">active</span>
    <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>Searchkick uses <code>find_in_batches</code> to import documents.  To eager load associations, use the <code>search_import</code> scope.</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="n">scope</span> <span class="ss">:search_import</span><span class="p">,</span> <span class="n">includes</span><span class="p">(</span><span class="ss">:searches</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>

<h3>
<a name="to-reindex-or-not-to-reindex" class="anchor" href="#to-reindex-or-not-to-reindex"><span class="octicon octicon-link"></span></a>To Reindex, or Not to Reindex</h3>

<h4>
<a name="reindex" class="anchor" href="#reindex"><span class="octicon octicon-link"></span></a>Reindex</h4>

<ul>
<li>when you install or upgrade searchkick</li>
<li>change the <code>search_data</code> method</li>
<li>change the <code>searchkick</code> method</li>
</ul><h4>
<a name="no-need-to-reindex" class="anchor" href="#no-need-to-reindex"><span class="octicon octicon-link"></span></a>No need to reindex</h4>

<ul>
<li>App starts</li>
<li>Records are inserted, updated or deleted (syncs automatically)</li>
</ul><h3>
<a name="keep-getting-better" class="anchor" href="#keep-getting-better"><span class="octicon octicon-link"></span></a>Keep Getting Better</h3>

<p>Searchkick uses conversion data to learn what users are looking for.  If a user searches for “ice cream” and adds Ben &amp; Jerry’s Chunky Monkey to the cart (our conversion metric at Instacart), that item gets a little more weight for similar searches.</p>

<p>The first step is to define your conversion metric and start tracking conversions.  The database works well for low volume, but feel free to use Redis or another datastore.</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Search</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="n">belongs_to</span> <span class="ss">:product</span>
  <span class="c1"># fields: id, query, searched_at, converted_at, product_id</span>
<span class="k">end</span>
</pre></div>

<p>You do <strong>not</strong> need to clean up the search queries.  Searchkick automatically treats <code>apple</code> and <code>APPLES</code> the same.</p>

<p>Next, add conversions to the index.  You must specify the conversions field as of version <code>0.2.0</code>.</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="n">has_many</span> <span class="ss">:searches</span>

  <span class="n">searchkick</span> <span class="ss">conversions</span><span class="p">:</span> <span class="s2">"conversions"</span> <span class="c1"># name of field</span>

  <span class="k">def</span> <span class="nf">search_data</span>
    <span class="p">{</span>
      <span class="nb">name</span><span class="p">:</span> <span class="nb">name</span><span class="p">,</span>
      <span class="ss">conversions</span><span class="p">:</span> <span class="n">searches</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">"query"</span><span class="p">)</span><span class="o">.</span><span class="n">count</span>
      <span class="c1"># {"ice cream" =&gt; 234, "chocolate" =&gt; 67, "cream" =&gt; 2}</span>
    <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>Reindex and set up a cron job to add new conversions daily.</p>

<div class="highlight"><pre><span class="n">rake</span> <span class="ss">searchkick</span><span class="p">:</span><span class="n">reindex</span> <span class="no">CLASS</span><span class="o">=</span><span class="no">Product</span>
</pre></div>

<h3>
<a name="personalized-results" class="anchor" href="#personalized-results"><span class="octicon octicon-link"></span></a>Personalized Results</h3>

<p>Order results differently for each user.  For example, show a user’s previously purchased products before other results.</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="n">searchkick</span> <span class="ss">personalize</span><span class="p">:</span> <span class="s2">"user_ids"</span>

  <span class="k">def</span> <span class="nf">search_data</span>
    <span class="p">{</span>
      <span class="nb">name</span><span class="p">:</span> <span class="nb">name</span><span class="p">,</span>
      <span class="n">user_ids</span><span class="p">:</span> <span class="n">orders</span><span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span> <span class="c1"># boost this product for these users</span>
      <span class="c1"># [4, 8, 15, 16, 23, 42]</span>
    <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>Reindex and search with:</p>

<div class="highlight"><pre><span class="no">Product</span><span class="o">.</span><span class="n">search</span> <span class="s2">"milk"</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="mi">8</span>
</pre></div>

<h3>
<a name="autocomplete" class="anchor" href="#autocomplete"><span class="octicon octicon-link"></span></a>Autocomplete</h3>

<p>Autocomplete predicts what a user will type, making the search experience faster and easier.</p>

<p><a href="https://github-camo.global.ssl.fastly.net/9ecf67854fb719ffd0b2eb5b0ae9504470a7d281/687474703a2f2f616e6b616e652e6769746875622e696f2f7365617263686b69636b2f6175746f636f6d706c6574652e706e67" target="_blank"><img src="https://github-camo.global.ssl.fastly.net/9ecf67854fb719ffd0b2eb5b0ae9504470a7d281/687474703a2f2f616e6b616e652e6769746875622e696f2f7365617263686b69636b2f6175746f636f6d706c6574652e706e67" alt="Autocomplete" style="max-width:100%;"></a></p>

<p>First, specify which fields use this feature.  This is necessary since autocomplete can increase the index size significantly, but don’t worry - this gives you blazing faster queries.</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">City</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="n">searchkick</span> <span class="ss">autocomplete</span><span class="p">:</span> <span class="o">[</span><span class="s2">"name"</span><span class="o">]</span>
<span class="k">end</span>
</pre></div>

<p>Reindex and search with:</p>

<div class="highlight"><pre><span class="no">City</span><span class="o">.</span><span class="n">search</span> <span class="s2">"san fr"</span><span class="p">,</span> <span class="ss">autocomplete</span><span class="p">:</span> <span class="kp">true</span>
</pre></div>

<p>Typically, you want to use a Javascript library like <a href="http://twitter.github.io/typeahead.js/">typeahead.js</a> or <a href="http://jqueryui.com/autocomplete/">jQuery UI</a>.</p>

<h4>
<a name="heres-how-to-make-it-work-with-rails" class="anchor" href="#heres-how-to-make-it-work-with-rails"><span class="octicon octicon-link"></span></a>Here’s how to make it work with Rails</h4>

<p>First, add a controller action.</p>

<div class="highlight"><pre><span class="c1"># app/controllers/cities_controller.rb</span>
<span class="k">class</span> <span class="nc">CitiesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">autocomplete</span>
    <span class="n">render</span> <span class="ss">json</span><span class="p">:</span> <span class="no">City</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:query</span><span class="o">]</span><span class="p">,</span> <span class="ss">autocomplete</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">limit</span><span class="p">:</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:name</span><span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>

<p>Then add the search box and Javascript code to a view.</p>

<div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">id=</span><span class="s">"query"</span> <span class="na">name=</span><span class="s">"query"</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"jquery.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"typeahead.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script&gt;</span>
  <span class="nx">$</span><span class="p">(</span><span class="s2">"#query"</span><span class="p">).</span><span class="nx">typeahead</span><span class="p">({</span>
    <span class="nx">name</span><span class="o">:</span> <span class="s2">"city"</span><span class="p">,</span>
    <span class="nx">remote</span><span class="o">:</span> <span class="s2">"/cities/autocomplete?query=%QUERY"</span>
  <span class="p">});</span>
<span class="nt">&lt;/script&gt;</span>
</pre></div>

<h3>
<a name="suggestions" class="anchor" href="#suggestions"><span class="octicon octicon-link"></span></a>Suggestions</h3>

<p><a href="https://github-camo.global.ssl.fastly.net/c9682040aadd5d5c72ed1c2643e829a4e12cf0d0/687474703a2f2f616e6b616e652e6769746875622e696f2f7365617263686b69636b2f726563757273696f6e2e706e67" target="_blank"><img src="https://github-camo.global.ssl.fastly.net/c9682040aadd5d5c72ed1c2643e829a4e12cf0d0/687474703a2f2f616e6b616e652e6769746875622e696f2f7365617263686b69636b2f726563757273696f6e2e706e67" alt="Suggest" style="max-width:100%;"></a></p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="n">searchkick</span> <span class="ss">suggest</span><span class="p">:</span> <span class="o">[</span><span class="s2">"name"</span><span class="o">]</span> <span class="c1"># fields to generate suggestions</span>
<span class="k">end</span>
</pre></div>

<p>Reindex and search with:</p>

<div class="highlight"><pre><span class="n">products</span> <span class="o">=</span> <span class="no">Product</span><span class="o">.</span><span class="n">search</span> <span class="s2">"peantu butta"</span><span class="p">,</span> <span class="ss">suggest</span><span class="p">:</span> <span class="kp">true</span>
<span class="n">products</span><span class="o">.</span><span class="n">suggestions</span> <span class="c1"># ["peanut butter"]</span>
</pre></div>

<h3>
<a name="facets" class="anchor" href="#facets"><span class="octicon octicon-link"></span></a>Facets</h3>

<p><a href="http://www.elasticsearch.org/guide/reference/api/search/facets/">Facets</a> provide aggregated search data.</p>

<p><a href="https://github-camo.global.ssl.fastly.net/16d4cf1db76cda4dac1cca3242f86fdd907631d5/687474703a2f2f616e6b616e652e6769746875622e696f2f7365617263686b69636b2f6661636574732e706e67" target="_blank"><img src="https://github-camo.global.ssl.fastly.net/16d4cf1db76cda4dac1cca3242f86fdd907631d5/687474703a2f2f616e6b616e652e6769746875622e696f2f7365617263686b69636b2f6661636574732e706e67" alt="Facets" style="max-width:100%;"></a></p>

<div class="highlight"><pre><span class="n">products</span> <span class="o">=</span> <span class="no">Product</span><span class="o">.</span><span class="n">search</span> <span class="s2">"chuck taylor"</span><span class="p">,</span> <span class="ss">facets</span><span class="p">:</span> <span class="o">[</span><span class="ss">:product_type</span><span class="p">,</span> <span class="ss">:gender</span><span class="p">,</span> <span class="ss">:brand</span><span class="o">]</span>
<span class="nb">p</span> <span class="n">products</span><span class="o">.</span><span class="n">facets</span>
</pre></div>

<p>Advanced</p>

<div class="highlight highlight-ruby"><pre><span class="no">Product</span><span class="o">.</span><span class="n">search</span> <span class="s2">"2% Milk"</span><span class="p">,</span> <span class="ss">facets</span><span class="p">:</span> <span class="p">{</span><span class="n">store_id</span><span class="p">:</span> <span class="p">{</span><span class="ss">where</span><span class="p">:</span> <span class="p">{</span><span class="n">in_stock</span><span class="p">:</span> <span class="kp">true</span><span class="p">},</span> <span class="ss">limit</span><span class="p">:</span> <span class="mi">10</span><span class="p">}}</span>
</pre></div>

<h3>
<a name="similar-items" class="anchor" href="#similar-items"><span class="octicon octicon-link"></span></a>Similar Items</h3>

<p>Find similar items.</p>

<div class="highlight"><pre><span class="n">product</span> <span class="o">=</span> <span class="no">Product</span><span class="o">.</span><span class="n">first</span>
<span class="n">product</span><span class="o">.</span><span class="n">similar</span><span class="p">(</span><span class="ss">fields</span><span class="p">:</span> <span class="o">[</span><span class="s2">"name"</span><span class="o">]</span><span class="p">)</span>
</pre></div>

<h3>
<a name="geospatial-searches" class="anchor" href="#geospatial-searches"><span class="octicon octicon-link"></span></a>Geospatial Searches</h3>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">City</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="n">searchkick</span> <span class="ss">locations</span><span class="p">:</span> <span class="o">[</span><span class="s2">"location"</span><span class="o">]</span>

  <span class="k">def</span> <span class="nf">search_data</span>
    <span class="n">to_hash</span><span class="o">.</span><span class="n">merge</span> <span class="ss">location</span><span class="p">:</span> <span class="o">[</span><span class="n">latitude</span><span class="o">.</span><span class="n">to_f</span><span class="p">,</span> <span class="n">longitude</span><span class="o">.</span><span class="n">to_f</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>Reindex and search with:</p>

<div class="highlight"><pre><span class="no">City</span><span class="o">.</span><span class="n">search</span> <span class="s2">"san"</span><span class="p">,</span> <span class="ss">where</span><span class="p">:</span> <span class="p">{</span><span class="ss">location</span><span class="p">:</span> <span class="p">{</span><span class="ss">near</span><span class="p">:</span> <span class="o">[</span><span class="mi">37</span><span class="p">,</span> <span class="o">-</span><span class="mi">114</span><span class="o">]</span><span class="p">,</span> <span class="ss">within</span><span class="p">:</span> <span class="s2">"100mi"</span><span class="p">}}</span> <span class="c1"># or 160km</span>
</pre></div>

<h2>
<a name="deployment" class="anchor" href="#deployment"><span class="octicon octicon-link"></span></a>Deployment</h2>

<p>Searchkick uses <code>ENV["ELASTICSEARCH_URL"]</code> for the Elasticsearch server.  This defaults to <code>http://localhost:9200</code>.</p>

<h3>
<a name="heroku" class="anchor" href="#heroku"><span class="octicon octicon-link"></span></a>Heroku</h3>

<p>Choose an add-on: <a href="https://addons.heroku.com/searchbox">SearchBox</a>, <a href="https://addons.heroku.com/bonsai">Bonsai</a>, or <a href="https://addons.heroku.com/foundelasticsearch">Found</a>.</p>

<div class="highlight"><pre><span class="c"># SearchBox</span>
heroku addons:add searchbox:starter
heroku config:add <span class="nv">ELASTICSEARCH_URL</span><span class="o">=</span><span class="sb">`</span>heroku config:get SEARCHBOX_URL<span class="sb">`</span>

<span class="c"># Bonsai</span>
heroku addons:add bonsai
heroku config:add <span class="nv">ELASTICSEARCH_URL</span><span class="o">=</span><span class="sb">`</span>heroku config:get BONSAI_URL<span class="sb">`</span>

<span class="c"># Found</span>
heroku addons:add foundelasticsearch
heroku config:add <span class="nv">ELASTICSEARCH_URL</span><span class="o">=</span><span class="sb">`</span>heroku config:get FOUNDELASTICSEARCH_URL<span class="sb">`</span>
</pre></div>

<p>Then deploy and reindex:</p>

<div class="highlight"><pre>heroku run rake searchkick:reindex <span class="nv">CLASS</span><span class="o">=</span>Product
</pre></div>

<h3>
<a name="other" class="anchor" href="#other"><span class="octicon octicon-link"></span></a>Other</h3>

<p>Create an initializer <code>config/initializers/elasticsearch.rb</code> with:</p>

<div class="highlight"><pre><span class="no">ENV</span><span class="o">[</span><span class="s2">"ELASTICSEARCH_URL"</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"http://username:password@api.searchbox.io"</span>
</pre></div>

<p>Then deploy and reindex:</p>

<div class="highlight"><pre>rake searchkick:reindex <span class="nv">CLASS</span><span class="o">=</span>Product
</pre></div>

<h2>
<a name="reference" class="anchor" href="#reference"><span class="octicon octicon-link"></span></a>Reference</h2>

<p>Searchkick requires Elasticsearch <code>0.90.0</code> or higher.</p>

<p>Reindex one record</p>

<div class="highlight"><pre><span class="n">product</span> <span class="o">=</span> <span class="no">Product</span><span class="o">.</span><span class="n">find</span> <span class="mi">10</span>
<span class="n">product</span><span class="o">.</span><span class="n">reindex</span>
</pre></div>

<p>Remove old indices</p>

<div class="highlight"><pre><span class="no">Product</span><span class="o">.</span><span class="n">clean_indices</span>
</pre></div>

<p>Use a different index name</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="n">searchkick</span> <span class="n">index_name</span><span class="p">:</span> <span class="s2">"products_v2"</span>
<span class="k">end</span>
</pre></div>

<p>Eager load associations</p>

<div class="highlight"><pre><span class="no">Product</span><span class="o">.</span><span class="n">search</span> <span class="s2">"milk"</span><span class="p">,</span> <span class="kp">include</span><span class="p">:</span> <span class="o">[</span><span class="ss">:brand</span><span class="p">,</span> <span class="ss">:stores</span><span class="o">]</span>
</pre></div>

<p>Do not load models</p>

<div class="highlight"><pre><span class="no">Product</span><span class="o">.</span><span class="n">search</span> <span class="s2">"milk"</span><span class="p">,</span> <span class="nb">load</span><span class="p">:</span> <span class="kp">false</span>
</pre></div>

<p>Reindex all models (Rails only)</p>

<div class="highlight"><pre>rake searchkick:reindex:all
</pre></div>

<h2>
<a name="migrating-from-tire" class="anchor" href="#migrating-from-tire"><span class="octicon octicon-link"></span></a>Migrating from Tire</h2>

<ol>
<li>
<p>Change <code>search</code> methods to <code>tire.search</code> and add index name in existing search calls</p>

<div class="highlight"><pre><span class="no">Product</span><span class="o">.</span><span class="n">search</span> <span class="s2">"fruit"</span>
</pre></div>

<p>should be replaced with</p>

<div class="highlight"><pre><span class="no">Product</span><span class="o">.</span><span class="n">tire</span><span class="o">.</span><span class="n">search</span> <span class="s2">"fruit"</span><span class="p">,</span> <span class="ss">index</span><span class="p">:</span> <span class="s2">"products"</span>
</pre></div>
</li>
<li>
<p>Replace tire mapping w/ searchkick method</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="n">searchkick</span>
<span class="k">end</span>
</pre></div>
</li>
<li>
<p>Deploy and reindex</p>

<div class="highlight"><pre><span class="n">rake</span> <span class="ss">searchkick</span><span class="p">:</span><span class="n">reindex</span> <span class="no">CLASS</span><span class="o">=</span><span class="no">Product</span> <span class="c1"># or Product.reindex in the console</span>
</pre></div>
</li>
<li><p>Once it finishes, replace search calls w/ searchkick calls</p></li>
</ol><h2>
<a name="elasticsearch-gotchas" class="anchor" href="#elasticsearch-gotchas"><span class="octicon octicon-link"></span></a>Elasticsearch Gotchas</h2>

<h3>
<a name="inconsistent-scores" class="anchor" href="#inconsistent-scores"><span class="octicon octicon-link"></span></a>Inconsistent Scores</h3>

<p>Due to the distributed nature of Elasticsearch, you can get incorrect results when the number of documents in the index is low.  You can <a href="http://www.elasticsearch.org/blog/understanding-query-then-fetch-vs-dfs-query-then-fetch/">read more about it here</a>.  To fix this, do:</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="n">searchkick</span> <span class="ss">settings</span><span class="p">:</span> <span class="p">{</span><span class="n">number_of_shards</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<span class="k">end</span>
</pre></div>

<h2>
<a name="thanks" class="anchor" href="#thanks"><span class="octicon octicon-link"></span></a>Thanks</h2>

<p>Thanks to Karel Minarik for <a href="https://github.com/karmi/tire">Tire</a>, Jaroslav Kalistsuk for <a href="https://gist.github.com/jarosan/3124884">zero downtime reindexing</a>, and Alex Leschenko for <a href="https://github.com/leschenko/elasticsearch_autocomplete">Elasticsearch autocomplete</a>.</p>

<h2>
<a name="todo" class="anchor" href="#todo"><span class="octicon octicon-link"></span></a>TODO</h2>

<ul>
<li>Make Searchkick work with any language</li>
</ul><h2>
<a name="history" class="anchor" href="#history"><span class="octicon octicon-link"></span></a>History</h2>

<p>View the <a href="https://github.com/ankane/searchkick/blob/master/CHANGELOG.md">changelog</a></p>

<h2>
<a name="contributing" class="anchor" href="#contributing"><span class="octicon octicon-link"></span></a>Contributing</h2>

<p>Everyone is encouraged to help improve this project. Here are a few ways you can help:</p>

<ul>
<li><a href="https://github.com/ankane/searchkick/issues">Report bugs</a></li>
<li>Fix bugs and <a href="https://github.com/ankane/searchkick/pulls">submit pull requests</a>
</li>
<li>Write, clarify, or fix documentation</li>
<li>Suggest or add new features</li>
</ul>

<!-- end readme -->

        </div>
      </div>
    </div>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-39027070-6', 'github.io');
      ga('send', 'pageview');
    </script>

  </body>
</html>
